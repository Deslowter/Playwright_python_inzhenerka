name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * *'

permissions:
  contents: write
  issues: write

jobs:
  test:
    name: Запуск тестов Playwright
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Установка Python и зависимостей
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv openjdk-11-jre wget unzip
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m playwright install --with-deps

      - name: Установка Allure Commandline
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip -O allure.zip
          unzip allure.zip -d /opt/
          sudo ln -s /opt/allure-2.35.1/bin/allure /usr/local/bin/allure
          allure --version

      - name: Запуск тестов
        run: |
          pytest --alluredir=allure-results -v --disable-warnings

      - name: Генерация Allure отчета
        if: always()
        run: |
          mkdir -p allure-report
          allure generate allure-results --clean -o allure-report

      - name: Локализация Allure отчета
        if: always()
        run: |
          sed -i 's/Overview/Обзор/g' allure-report/index.html
          sed -i 's/Suites/Наборы тестов/g' allure-report/index.html
          sed -i 's/Graphs/Графики/g' allure-report/index.html
          sed -i 's/Timeline/Хронология/g' allure-report/index.html
          sed -i 's/Behaviors/Поведение/g' allure-report/index.html
          sed -i 's/Packages/Пакеты/g' allure-report/index.html

      - name: Публикация Allure отчета на GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report