# NOTE: This workflow requires that the current repo have a branch 'gh-pages' to hold the github pages source
name: Playwright Tests
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'
permissions:
  contents: write
  issues: write
jobs:
  test:
    name: Запуск тестов Playwright
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Установка Python и зависимостей
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv openjdk-11-jre wget unzip
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m playwright install --with-deps

      - name: Установка Allure Commandline
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip -O allure.zip
          unzip allure.zip -d /opt/
          sudo ln -s /opt/allure-2.35.1/bin/allure /usr/local/bin/allure
          allure --version

      - name: Запуск тестов
        run: |
          pytest --alluredir=allure-results -v --disable-warnings

      - name: Генерация Allure отчета
        if: always()
        run: |
          mkdir -p allure-results/history
          cp -r gh-pages/history/* allure-results/history/ || true  # Копируем историю, если она существует
          mkdir -p allure-report
          allure generate allure-results --clean -o allure-report
          
          # Опционально: Ограничение на количество хранимых отчётов (оставляем последние 20)
          if [ -d "allure-report/history" ]; then
            cd allure-report/history
            ls -1t | tail -n +21 | xargs -r rm -rf  # Удаляем старые директории (сортировка по времени создания, tail +21 удаляет всё после 20 новых)
            cd ../..
          fi

      - name: Локализация Allure отчета
        if: always()
        run: |
          sed -i 's/Overview/Обзор/g' allure-report/index.html
          sed -i 's/Suites/Наборы тестов/g' allure-report/index.html
          sed -i 's/Graphs/Графики/g' allure-report/index.html
          sed -i 's/Timeline/Хронология/g' allure-report/index.html
          sed -i 's/Behaviors/Поведение/g' allure-report/index.html
          sed -i 's/Packages/Пакеты/g' allure-report/index.html

      - name: Публикация Allure отчета на GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4  # Обновлено на v4 для consistency с примерами
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report