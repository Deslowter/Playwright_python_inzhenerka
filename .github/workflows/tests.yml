name: Playwright Tests (Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * *'

permissions:
  contents: write
  issues: write

# –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –ø—Ä–∏ –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–∞—Ö
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ 4 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∏
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # –ö—ç—à–∏—Ä—É–µ–º Python –∏ pip –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Setup Python with cache
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      # –ö—ç—à–∏—Ä—É–µ–º Playwright –±—Ä–∞—É–∑–µ—Ä—ã
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-browsers-${{ runner.os }}-

      # –ö—ç—à–∏—Ä—É–µ–º Allure
      - name: Cache Allure
        uses: actions/cache@v4
        id: allure-cache
        with:
          path: /opt/allure-2.35.1
          key: allure-2.35.1-${{ runner.os }}

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      - name: Install system dependencies
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
          libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 \
          libxrandr2 libgbm1 libasound2

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—Å –∫—ç—à–µ–º pip —ç—Ç–æ –±—ã—Å—Ç—Ä–æ)
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pytest-xdist  # –î–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
          pip install -r requirements.txt

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Playwright –±—Ä–∞—É–∑–µ—Ä—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: playwright install chromium --with-deps

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Allure —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è
      - name: Install Allure
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip -O allure.zip
          unzip -q allure.zip -d /opt/
          rm allure.zip

      - name: Add Allure to PATH
        run: echo "/opt/allure-2.35.1/bin" >> $GITHUB_PATH

      # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: |
          pytest \
            --alluredir=allure-results-${{ matrix.shard }} \
            --shard-id=${{ matrix.shard }} \
            --num-shards=4 \
            -n auto \
            --dist loadgroup \
            -v \
            --disable-warnings \
            --tb=short

      # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.shard }}
          path: allure-results-${{ matrix.shard }}
          retention-days: 7

  # –û—Ç–¥–µ–ª—å–Ω–∞—è job –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤)
  report:
    name: Generate Report
    needs: test
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # –ö—ç—à–∏—Ä—É–µ–º Allure –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
      - name: Cache Allure
        uses: actions/cache@v4
        with:
          path: /opt/allure-2.35.1
          key: allure-2.35.1-${{ runner.os }}

      - name: Setup Allure
        run: |
          if [ ! -d "/opt/allure-2.35.1" ]; then
            wget -q https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip
            unzip -q allure-2.35.1.zip -d /opt/
          fi
          echo "/opt/allure-2.35.1/bin" >> $GITHUB_PATH

      # –°–∫–∞—á–∏–≤–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ –≤—Å–µ—Ö —à–∞—Ä–¥–æ–≤
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: allure-results-combined

      # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      - name: Merge test results
        run: |
          mkdir -p allure-results
          find allure-results-combined -type f -name "*.json" -exec cp {} allure-results/ \;

      # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
      - name: Generate Allure report
        run: |
          mkdir -p allure-report
          allure generate allure-results --clean -o allure-report

      # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
      - name: Localize Allure report
        run: |
          find allure-report -name "*.html" -type f -exec sed -i \
            -e 's/Overview/–û–±–∑–æ—Ä/g' \
            -e 's/Suites/–ù–∞–±–æ—Ä—ã —Ç–µ—Å—Ç–æ–≤/g' \
            -e 's/Graphs/–ì—Ä–∞—Ñ–∏–∫–∏/g' \
            -e 's/Timeline/–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è/g' \
            -e 's/Behaviors/–ü–æ–≤–µ–¥–µ–Ω–∏–µ/g' \
            -e 's/Packages/–ü–∞–∫–µ—Ç—ã/g' {} +

      # –ü—É–±–ª–∏–∫—É–µ–º –æ—Ç—á–µ—Ç
      - name: Publish Allure report
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ—Ç—á–µ—Ç
      - name: Comment PR with report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìä Allure Test Report
              
              –û—Ç—á–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/
              
              **Run:** ${{ github.run_number }}
              **Commit:** ${{ github.sha }}`
            })